{% extends 'minecraft_app/base.html' %}
{% load static %}

{% block title %}Shopping Cart - Novania Towny Earth Server{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/store.css' %}">
<link rel="stylesheet" href="{% static 'css/cart.css' %}">
{% endblock %}

{% block content %}
<!-- Cart Hero Section -->
<section class="cart-hero">
    <div class="cart-particles" id="cart-particles"></div>
    <div class="cart-hero-content">
        <h1 class="cart-hero-title">Shopping Cart</h1>
        <p class="cart-hero-subtitle">Review your items before checkout</p>
    </div>
</section>

<!-- Cart Main Section -->
<section class="cart-main-section">
    <div class="container">
        <div class="cart-container">
            {% if cart_items %}
                <div class="cart-items">
                    <div class="cart-header">
                        <div class="cart-header-item product">Product</div>
                        <div class="cart-header-item price">Price</div>
                        <div class="cart-header-item quantity">Qty</div>
                        <div class="cart-header-item subtotal">Subtotal</div>
                        <div class="cart-header-item actions">Actions</div>
                    </div>
                    
                    {% for item in cart_items %}
                        <div class="cart-item">
                            <div class="cart-item-product">
                                {% if item.rank %}
                                    <div class="item-image rank-image" style="background-color: {{ item.rank.color_code }}">
                                        <i class="fas fa-crown"></i>
                                    </div>
                                    <div class="item-details">
                                        <h3 class="item-name">{{ item.rank.name }} Rank</h3>
                                        <p class="item-description">{{ item.rank.description|truncatechars:100 }}</p>
                                    </div>
                                {% elif item.store_item %}
                                    <div class="item-image {% if item.store_item.image %}with-image{% else %}no-image{% endif %}" {% if not item.store_item.image %}style="background-color: {{ item.store_item.color_code }}"{% endif %}>
                                        {% if item.store_item.image %}
                                            <img src="{{ item.store_item.image }}" alt="{{ item.store_item.name }}">
                                        {% else %}
                                            <i class="fas fa-gift"></i>
                                        {% endif %}
                                    </div>
                                    <div class="item-details">
                                        <h3 class="item-name">{{ item.store_item.name }}</h3>
                                        <p class="item-description">{{ item.store_item.description|truncatechars:100 }}</p>
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="cart-item-price">
                                €{% if item.store_item %}{{ item.get_subtotal|floatformat:2 }}{% else %}{{ item.rank.price }}{% endif %}
                            </div>
                            
                            <div class="cart-item-quantity">
                                {% if item.store_item %}
                                    <form action="{% url 'update_cart_quantity' %}" method="POST" class="quantity-form" data-item-id="{{ item.id }}" data-item-price="{{ item.store_item.price }}">
                                        {% csrf_token %}
                                        <input type="hidden" name="item_id" value="{{ item.id }}">
                                        <div class="quantity-control">
                                            <button type="button" class="quantity-btn minus">-</button>
                                            <input type="number" name="quantity" value="{{ item.quantity }}" min="1" max="99" class="quantity-input">
                                            <button type="button" class="quantity-btn plus">+</button>
                                        </div>
                                        <!-- Update button removed -->
                                    </form>
                                {% else %}
                                    <span class="fixed-quantity">1</span>
                                {% endif %}
                            </div>
                            
                            <div class="cart-item-subtotal">
                                €{{ item.get_subtotal }}
                            </div>
                            
                            <div class="cart-item-actions">
                                <a href="{% url 'remove_from_cart' item.id %}" class="remove-item-btn" title="Remove from cart">
                                    <i class="fas fa-trash-alt"></i>
                                </a>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                
                <div class="cart-summary">
                    <h2 class="summary-title">Order Summary</h2>
                    
                    <div class="summary-items">
                        <div class="summary-item">
                            <span class="summary-label">Items ({{ cart_items|length }}):</span>
                            <span class="summary-value">€{{ total }}</span>
                        </div>
                        
                        <div class="summary-item">
                            <span class="summary-label">Discount:</span>
                            <span class="summary-value">€0.00</span>
                        </div>
                        
                        <div class="summary-divider"></div>
                        
                        <div class="summary-item total">
                            <span class="summary-label">Total:</span>
                            <span class="summary-value">€{{ total }}</span>
                        </div>
                    </div>
                    
                    <form action="{% url 'checkout_cart' %}" method="POST" class="checkout-form">
                        {% csrf_token %}
                        <button type="submit" class="checkout-btn">
                            <i class="fas fa-lock"></i> Proceed to Checkout
                        </button>
                    </form>
                    
                    <div class="continue-shopping">
                        <a href="{% url 'store' %}" class="continue-shopping-link">
                            <i class="fas fa-arrow-left"></i> Continue Shopping
                        </a>
                    </div>
                </div>
            {% else %}
                <div class="empty-cart">
                    <div class="empty-cart-icon">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <h2>Your cart is empty</h2>
                    <p>Looks like you haven't added any items to your cart yet.</p>
                    <a href="{% url 'store' %}" class="continue-shopping-btn">
                        Continue Shopping
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</section>

<!-- Payment Methods Section -->
<section class="cart-payment-section">
    <div class="container">
        <div class="payment-info">
            <h2>Secure Payment</h2>
            <p>We use Stripe to process all payments securely. Your payment information is never stored on our servers.</p>
            
            <div class="payment-methods">
                <div class="payment-method visa">
                    <i class="fab fa-cc-visa"></i>
                </div>
                <div class="payment-method mastercard">
                    <i class="fab fa-cc-mastercard"></i>
                </div>
                <div class="payment-method amex">
                    <i class="fab fa-cc-amex"></i>
                </div>
                <div class="payment-method discover">
                    <i class="fab fa-cc-discover"></i>
                </div>
                <div class="payment-method stripe">
                    <i class="fab fa-stripe"></i>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Create particles for the cart-particles container
        const particlesContainer = document.getElementById('cart-particles');
        if (particlesContainer) {
            const particleCount = window.innerWidth < 768 ? 20 : 40;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                
                // Random size
                const size = Math.random() * 4 + 2;
                particle.style.width = size + 'px';
                particle.style.height = size + 'px';
                
                // Random position
                particle.style.top = Math.random() * 100 + '%';
                particle.style.left = Math.random() * 100 + '%';
                
                // Random opacity
                particle.style.opacity = Math.random() * 0.5 + 0.3;
                
                // Animation delay
                particle.style.animationDelay = Math.random() * 5 + 's';
                
                particlesContainer.appendChild(particle);
            }
        }
        
        // AJAX quantity update functionality
        function updateQuantity(itemId, quantity, button) {
            console.log("Updating quantity for item ID:", itemId, "to", quantity);
            
            // Find the cart item container
            const cartItem = button.closest('.cart-item');
            if (!cartItem) {
                console.error("Cart item container not found");
                return;
            }
            
            // Find the form within the cart item
            const form = cartItem.querySelector('form.quantity-form');
            if (!form) {
                console.error("Form not found in cart item");
                return;
            }
            
            // Get the CSRF token from the form
            const csrfToken = form.querySelector('input[name="csrfmiddlewaretoken"]').value;
            
            // Create form data for the request
            const formData = new FormData();
            formData.append('item_id', itemId);
            formData.append('quantity', quantity);
            formData.append('csrfmiddlewaretoken', csrfToken);
            
            // Show loading indicator
            cartItem.style.opacity = '0.7';
            
            // Log form details for debugging
            console.log("Form action:", form.action);
            console.log("Form method:", form.method);
            console.log("CSRF token:", csrfToken);
            
            // Send AJAX request
            fetch('/cart/update/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                console.log("Response status:", response.status);
                return response.json();
            })
            .then(data => {
                console.log("Response data:", data);
                
                if (data.success) {
                    // Handle minimal test view response
                    if (data.message && data.message.includes('Minimal test view')) {
                        console.log('Minimal test view response:', data.message);
                        return; // Ne pas mettre à jour l'interface pour la vue minimale
                    }
                    
                    // Format numbers to 2 decimal places
                    const formattedSubtotal = data.item_subtotal ? parseFloat(data.item_subtotal).toFixed(2) : '0.00';
                    const formattedTotal = data.cart_total ? parseFloat(data.cart_total).toFixed(2) : '0.00';
                    
                    // Update subtotal display
                    const subtotalElement = cartItem.querySelector('.cart-item-subtotal');
                    if (subtotalElement) {
                        subtotalElement.textContent = '€' + formattedSubtotal;
                        console.log("Updated subtotal to:", formattedSubtotal);
                    } else {
                        console.error("Subtotal element not found");
                    }
                    
                    // Update order total
                    const totalElement = document.querySelector('.summary-item.total .summary-value');
                    if (totalElement) {
                        totalElement.textContent = '€' + formattedTotal;
                        console.log("Updated total to:", formattedTotal);
                    } else {
                        console.error("Total element not found");
                    }
                    
                    // Synchroniser l'input avec la quantité réelle
                    const input = form.querySelector('input[name="quantity"]');
                    if (input && data.current_quantity) {
                        input.value = data.current_quantity;
                        console.log("Input quantity updated to:", data.current_quantity);
                    } else {
                        console.error("Quantity input not found or current_quantity missing");
                    }
                    
                    console.log('Quantity updated successfully');
                } else {
                    console.error('Error updating quantity:', data.error);
                    const input = form.querySelector('input[name="quantity"]');
                    if (input && data.current_quantity) {
                        input.value = data.current_quantity;
                    }
                    alert(data.error); // Afficher l'erreur à l'utilisateur
                }
            })
            .catch(error => {
                console.error('AJAX error:', error);
            })
            .finally(() => {
                // Remove loading indicator
                cartItem.style.opacity = '1';
            });
        }
        
        // Advanced quantity button handling
        console.log("Advanced quantity buttons fix loaded");
        
        // Direct handler for all click events
        document.body.addEventListener('click', function(event) {
            // Handling minus button clicks
            if (event.target.classList.contains('minus') || 
                (event.target.parentElement && event.target.parentElement.classList.contains('minus'))) {
                
                const button = event.target.classList.contains('minus') ? event.target : event.target.parentElement;
                console.log("Minus button clicked:", button);
                
                // Find the cart item
                const cartItem = button.closest('.cart-item');
                if (!cartItem) {
                    console.error("Cart item not found for minus button");
                    return;
                }
                
                // Find the item ID from the form
                const form = cartItem.querySelector('form.quantity-form');
                if (!form) {
                    console.error("Form not found in cart item");
                    return;
                }
                
                const itemId = form.querySelector('input[name="item_id"]').value;
                console.log("Item ID from hidden input:", itemId);
                
                // Find the input element
                const input = button.closest('.quantity-control').querySelector('input[type="number"]');
                if (input) {
                    console.log("Input found:", input, "Current value:", input.value);
                    
                    const currentValue = parseInt(input.value) || 1;
                    const minValue = parseInt(input.min) || 1;
                    
                    if (currentValue > minValue) {
                        // Update the value
                        input.value = currentValue - 1;
                        console.log("Value decreased to:", input.value);
                        
                        // Send AJAX request to update the quantity
                        updateQuantity(itemId, input.value, button);
                    } else {
                        console.log("Already at minimum value");
                    }
                }
            }
            
            // Handling plus button clicks
            if (event.target.classList.contains('plus') || 
                (event.target.parentElement && event.target.parentElement.classList.contains('plus'))) {
                
                const button = event.target.classList.contains('plus') ? event.target : event.target.parentElement;
                console.log("Plus button clicked:", button);
                
                // Find the cart item
                const cartItem = button.closest('.cart-item');
                if (!cartItem) {
                    console.error("Cart item not found for plus button");
                    return;
                }
                
                // Find the item ID from the form
                const form = cartItem.querySelector('form.quantity-form');
                if (!form) {
                    console.error("Form not found in cart item");
                    return;
                }
                
                const itemId = form.querySelector('input[name="item_id"]').value;
                console.log("Item ID from hidden input:", itemId);
                
                // Find the input element
                const input = button.closest('.quantity-control').querySelector('input[type="number"]');
                if (input) {
                    console.log("Input found:", input, "Current value:", input.value);
                    
                    const currentValue = parseInt(input.value) || 1;
                    const maxValue = 99;  // Set a fixed high value
                    
                    if (currentValue < maxValue) {
                        // Update the value
                        input.value = currentValue + 1;
                        console.log("Value increased to:", input.value);
                        
                        // Send AJAX request to update the quantity
                        updateQuantity(itemId, input.value, button);
                    } else {
                        console.log("Already at maximum value");
                    }
                }
            }
        });
    });
</script>
{% endblock %}