{% extends 'minecraft_app/base.html' %}
{% load static %}

{% block title %}Store - Novania Towny Earth Server{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/store.css' %}">
{% endblock %}

{% block content %}
<!-- Hero Store Section -->
<section class="store-hero">
    <div class="store-particles" id="store-particles"></div>
    <div class="store-hero-content">
        <h1 class="store-title">Novania Store</h1>
        <p class="store-subtitle">Support the server and enhance your experience</p>
        
        <div class="store-description">
            <p>Our server is maintained by a passionate team of volunteers. Your support helps us cover server costs and develop new features for everyone to enjoy. Browse our premium ranks and exclusive treasures!</p>
        </div>
    </div>
</section>

<!-- Store Navigation -->
<section class="store-navigation">
    <div class="container">
        <div class="store-tabs">
            <button class="store-tab active" data-tab="ranks">Premium Ranks</button>
            <button class="store-tab" data-tab="treasures">Exclusive Treasures</button>
        </div>
        
        <!-- Shopping Cart Indicator -->
        <div class="cart-indicator">
            <a href="{% url 'cart' %}" class="cart-link">
                <i class="fas fa-shopping-cart"></i>
                <span class="cart-count">{{ cart_count|default:"0" }}</span>
                <span class="cart-total">€{{ cart_total|default:"0.00" }}</span>
            </a>
        </div>
    </div>
</section>

<!-- Store Products Section -->
<section class="store-products-section">
    <div class="container">
        <!-- Ranks Tab Content -->
        <div class="store-tab-content active" id="ranks-content">
            <h2 class="section-title">Premium Ranks</h2>
            <p class="section-subtitle">Unlock special perks and privileges</p>
            
            {% if show_new_ranks_notice %}
                <div class="new-ranks-notice">
                    <div class="notice-icon">
                        <i class="fas fa-crown"></i>
                    </div>
                    <h3>You've reached the highest rank!</h3>
                    <p>New ranks coming soon! Stay tuned for more exclusive content.</p>
                </div>
            {% else %}
                <div class="store-grid">
                    {% for rank in ranks %}
                        <div class="product-card product-{{ rank.name|lower }}">
                            <div class="product-header">
                                <h3 class="product-name" style="color: {{ rank.color_code }}">{{ rank.name }}</h3>
                                <div class="product-price">€{{ rank.price }}<span class="price-unit">/lifetime</span></div>
                                {% if rank.name == "Premium" %}
                                    <div class="product-badge">Most Popular</div>
                                {% endif %}
                            </div>
                            
                            <div class="product-content">
                                <div class="product-description">
                                    {{ rank.description }}
                                </div>
                                
                                <!-- Bouton pour afficher les features -->
                                <div class="features-separator"></div>
                                <button class="toggle-features" style="background: linear-gradient(to right, {{ rank.color_code }}99, {{ rank.color_code }})" data-rank="{{ rank.name|lower }}">
                                    <span>View Features</span>
                                    <span class="features-count">{{ rank.get_features_list|length }}</span>
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                                
                                <div class="product-features" id="features-{{ rank.name|lower }}">
                                    <ul class="feature-list">
                                        {% for feature in rank.get_features_list %}
                                            <li><i class="fas fa-check-circle"></i> {{ feature }}</li>
                                        {% empty %}
                                            <li><i class="fas fa-check-circle"></i> No features specified</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                            
                            <div class="product-footer">
                                <form action="{% url 'add_to_cart' %}" method="POST" class="quantity-form">
                                    {% csrf_token %}
                                    <input type="hidden" name="item_type" value="rank">
                                    <input type="hidden" name="item_id" value="{{ rank.id }}">
                                    <button type="submit" class="btn-purchase" style="background: linear-gradient(to right, {{ rank.color_code }}, {{ rank.color_code }}CC);">
                                        <i class="fas fa-cart-plus"></i> Add to Cart
                                    </button>
                                </form>
                                
                                <a href="{% url 'gift_rank' rank.id %}" class="btn-purchase gift-btn">
                                    <i class="fas fa-gift"></i> Gift This Rank
                                </a>
                            </div>
                        </div>
                    {% empty %}
                        {% if user_has_any_rank %}
                            <div class="no-ranks-available">
                                <p>No higher ranks are currently available for purchase.</p>
                            </div>
                        {% else %}
                            <div class="no-ranks-available">
                                <p>No ranks are currently available.</p>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            {% endif %}
        </div>
        
        <!-- Treasures Tab Content -->
        <div class="store-tab-content" id="treasures-content">
            <h2 class="section-title">Exclusive Treasures</h2>
            <p class="section-subtitle">Enhance your gameplay with unique items and services</p>
            
            <div class="store-categories">
                <button class="category-btn active" data-category="all">All</button>
                <button class="category-btn" data-category="collectible">Collectibles</button>
                <button class="category-btn" data-category="cosmetic">Cosmetics</button>
                <button class="category-btn" data-category="utility">Utilities</button>
                <button class="category-btn" data-category="special">Specials</button>
            </div>
            
            <div class="store-grid treasures-grid">
                {% for item in store_items %}
                <div class="treasure-card" data-category="{{ item.category }}">
                    <div class="treasure-image">
                        {% if item.image %}
                            <img src="{{ item.image }}" alt="{{ item.name }}">
                        {% else %}
                            <div class="treasure-placeholder" style="background-color: {{ item.color_code }}">
                                <i class="fas fa-gift"></i>
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="treasure-content">
                        <div class="treasure-category">{{ item.get_category_display }}</div>
                        <h3 class="treasure-name" style="color: {{ item.color_code }}">{{ item.name }}</h3>
                        <p class="treasure-description">{{ item.description }}</p>
                    </div>
                    
                    <div class="treasure-footer">
                        <div class="treasure-price-row">
                            <div class="treasure-price">€{{ item.price }}</div>
                            
                            <form action="{% url 'add_to_cart' %}" method="POST" class="treasure-cart-form quantity-form">
                                {% csrf_token %}
                                <input type="hidden" name="item_type" value="store_item">
                                <input type="hidden" name="item_id" value="{{ item.id }}">
                                
                                <div class="quantity-control">
                                    <button type="button" class="quantity-btn minus">-</button>
                                    <input type="number" name="quantity" value="1" min="1" max="99" class="quantity-input">
                                    <button type="button" class="quantity-btn plus">+</button>
                                </div>
                                
                                <button type="submit" class="add-to-cart-btn" style="background-color: {{ item.color_code }};">
                                    <i class="fas fa-cart-plus"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <div class="payment-section">
            <h3 class="payment-title">Secure Payment Methods</h3>
            <p class="payment-description">We accept various payment methods for your convenience. All transactions are secure and encrypted.</p>
            
            <div class="payment-methods">
                <div class="payment-method visa">
                    <i class="fab fa-cc-visa" title="Visa"></i>
                </div>
                <div class="payment-method mastercard">
                    <i class="fab fa-cc-mastercard" title="Mastercard"></i>
                </div>
                <div class="payment-method stripe">
                    <i class="fab fa-cc-stripe" title="Stripe"></i>
                </div>
                <div class="payment-method other">
                    <i class="fas fa-credit-card" title="Other Cards"></i>
                </div>
            </div>
        </div>
        
        <!-- FAQ Section -->
        <div class="faq-section">
            <h2 class="faq-title">Frequently Asked Questions</h2>
            
            <div class="faq-container">
                <div class="faq-item">
                    <div class="faq-question">
                        <h3>How long do ranks and items last?</h3>
                        <span class="faq-icon"><i class="fas fa-chevron-down"></i></span>
                    </div>
                    <div class="faq-answer">
                        <p>All purchased ranks on Novania are permanent. Once you buy a rank, you keep it forever, even through server resets or map changes. Special items vary - some are permanent while others may be consumable. The description of each item will specify its duration.</p>
                    </div>
                </div>
                
                <div class="faq-item">
                    <div class="faq-question">
                        <h3>How do I receive my purchases after payment?</h3>
                        <span class="faq-icon"><i class="fas fa-chevron-down"></i></span>
                    </div>
                    <div class="faq-answer">
                        <p>Ranks and digital items are usually applied automatically within minutes of a successful purchase. The system links your website account to your Minecraft username. For custom or special items that require staff intervention, our team will contact you within 24 hours. If you don't receive your purchase within the expected timeframe, please contact a staff member on our Discord server.</p>
                    </div>
                </div>
                
                <div class="faq-item">
                    <div class="faq-question">
                        <h3>Can I upgrade my rank later?</h3>
                        <span class="faq-icon"><i class="fas fa-chevron-down"></i></span>
                    </div>
                    <div class="faq-answer">
                        <p>Yes! If you already have a rank and want to upgrade to a higher one, you'll only need to pay the difference. Contact a staff member for assistance with upgrades.</p>
                    </div>
                </div>
                
                <div class="faq-item">
                    <div class="faq-question">
                        <h3>Where does the money go?</h3>
                        <span class="faq-icon"><i class="fas fa-chevron-down"></i></span>
                    </div>
                    <div class="faq-answer">
                        <p>All funds from purchases go directly toward server costs, including hosting, domain fees, development, and future expansions. We're a non-profit community project run by volunteers.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="summary-container">
        <div class="summary-content">
            <h3>Shop Summary</h3>
            <ul>
                <li><strong>Items in Cart :</strong> <span id="cart-count">{{ cart_count|default:"0" }}</span></li>
                <li><strong>Cart Total :</strong> <span id="cart-total">€{{ cart_total|default:"0.00" }}</span></li>
            </ul>
            <a href="{% url 'cart' %}" class="btn-cart">
                <i class="fas fa-shopping-cart"></i> View Cart
            </a>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
// Define the add_to_cart URL as a JavaScript variable
const addToCartUrl = "{% url 'add_to_cart' %}";

// Ensemble pour suivre les grades ajoutés au panier
const addedRanks = new Set();

document.addEventListener('DOMContentLoaded', function() {
    // Create particles for the store-particles container
    const particlesContainer = document.getElementById('store-particles');
    if (particlesContainer) {
        const particleCount = window.innerWidth < 768 ? 20 : 40;
        
        for (let i = 0; i < particleCount; i++) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            
            const size = Math.random() * 4 + 2;
            particle.style.width = size + 'px';
            particle.style.height = size + 'px';
            
            particle.style.top = Math.random() * 100 + '%';
            particle.style.left = Math.random() * 100 + '%';
            
            particle.style.opacity = Math.random() * 0.5 + 0.3;
            
            particle.style.animationDelay = Math.random() * 5 + 's';
            
            particlesContainer.appendChild(particle);
        }
    }
    
    // Toggle Features Functionality
    const toggleFeaturesBtns = document.querySelectorAll('.toggle-features');
    
    toggleFeaturesBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const rankName = this.getAttribute('data-rank');
            const featuresElement = document.getElementById(`features-${rankName}`);
            
            // Toggle expanded class
            featuresElement.classList.toggle('expanded');
            this.classList.toggle('expanded');
            
            // Change button text
            const buttonText = this.querySelector('span');
            if (featuresElement.classList.contains('expanded')) {
                buttonText.textContent = 'Hide Features';
                // Ajout d'une classe pour l'animation du contour
                this.classList.add('pulsing');
                setTimeout(() => {
                    this.classList.remove('pulsing');
                }, 1000);
            } else {
                buttonText.textContent = 'View Features';
            }
        });
    });
    
    // Show/hide summary container on scroll
    window.addEventListener('scroll', function() {
        const summaryContainer = document.querySelector('.summary-container');
        if (summaryContainer) {
            if (window.scrollY > 200) {
                summaryContainer.classList.add('visible');
            } else {
                summaryContainer.classList.remove('visible');
            }
        }
    });

    // Initialize summary visibility on page load
    const summaryContainer = document.querySelector('.summary-container');
    if (summaryContainer && window.scrollY > 200) {
        summaryContainer.classList.add('visible');
    }
    
    // Store Tabs
    const storeTabs = document.querySelectorAll('.store-tab');
    const storeContents = document.querySelectorAll('.store-tab-content');
    
    storeTabs.forEach(tab => {
        tab.addEventListener('click', function() {
            storeTabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            storeContents.forEach(content => content.classList.remove('active'));
            const tabId = this.getAttribute('data-tab');
            document.getElementById(tabId + '-content').classList.add('active');
        });
    });
    
    // Category Filter
    const categoryBtns = document.querySelectorAll('.category-btn');
    const treasureCards = document.querySelectorAll('.treasure-card');
    
    categoryBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            categoryBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            const category = this.getAttribute('data-category');
            treasureCards.forEach(card => {
                if (category === 'all' || card.getAttribute('data-category') === category) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        });
    });
    
    // Improved Quantity Buttons
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('quantity-btn') || e.target.closest('.quantity-btn')) {
            e.preventDefault();
            e.stopPropagation();
            
            const button = e.target.classList.contains('quantity-btn') ? e.target : e.target.closest('.quantity-btn');
            const control = button.closest('.quantity-control');
            if (!control) return;
            
            const input = control.querySelector('.quantity-input');
            if (!input) return;
            
            const currentValue = parseInt(input.value) || 1;
            const minValue = parseInt(input.min) || 1;
            const maxValue = parseInt(input.max) || 99;
            
            if (button.classList.contains('minus')) {
                if (currentValue > minValue) {
                    input.value = currentValue - 1;
                    input.dispatchEvent(new Event('change', { bubbles: true }));
                }
            } else if (button.classList.contains('plus')) {
                if (currentValue < maxValue) {
                    input.value = currentValue + 1;
                    input.dispatchEvent(new Event('change', { bubbles: true }));
                } else {
                    showMessage('Maximum quantity is ' + maxValue, 'error');
                }
            }
        }
    });
    
    // FAQ Functionality
    const faqQuestions = document.querySelectorAll('.faq-question');
    
    faqQuestions.forEach(question => {
        question.addEventListener('click', function() {
            const faqItem = this.closest('.faq-item');
            const answer = this.nextElementSibling;
            const icon = this.querySelector('.faq-icon i');
            const isActive = faqItem.classList.contains('active');
            
            document.querySelectorAll('.faq-item').forEach(item => {
                if (item !== faqItem) {
                    item.classList.remove('active');
                    const itemAnswer = item.querySelector('.faq-answer');
                    itemAnswer.style.maxHeight = null;
                    const itemIcon = item.querySelector('.faq-icon i');
                    if (itemIcon) itemIcon.classList.replace('fa-chevron-up', 'fa-chevron-down');
                }
            });
            
            if (!isActive) {
                faqItem.classList.add('active');
                answer.style.maxHeight = answer.scrollHeight + 'px';
                if (icon) icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
            } else {
                faqItem.classList.remove('active');
                answer.style.maxHeight = null;
                if (icon) icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
            }
        });
    });
    
    // Update summary container with cart data
    function updateSummary(cartCount, cartTotal) {
        const cartCountElement = document.querySelector('#cart-count');
        const cartTotalElement = document.querySelector('#cart-total');
        
        if (cartCountElement) {
            cartCountElement.textContent = cartCount || 0;
        }
        if (cartTotalElement) {
            cartTotalElement.textContent = cartTotal ? `€${parseFloat(cartTotal).toFixed(2)}` : '€0.00';
        }
    }
    
    // Update cart indicator and summary
    function updateCartIndicator(count, total) {
        const cartCount = document.querySelector('.cart-count');
        const cartTotal = document.querySelector('.cart-total');
        
        if (cartCount) {
            cartCount.textContent = count || 0;
            cartCount.classList.add('pulse');
            setTimeout(() => {
                cartCount.classList.remove('pulse');
            }, 500);
        }
        
        if (cartTotal && total !== undefined) {
            cartTotal.textContent = `€${parseFloat(total).toFixed(2)}`;
        }
        
        // Update summary container
        updateSummary(count, total);
    }
    
    // Convertir tous les formulaires d'ajout au panier en AJAX
    const addToCartForms = document.querySelectorAll(`form[action="${addToCartUrl}"]`);
    
    addToCartForms.forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const itemType = form.querySelector('input[name="item_type"]').value;
            const itemId = form.querySelector('input[name="item_id"]').value;
            
            if (itemType === 'rank' && addedRanks.has(itemId)) {
                showMessage('Ce grade est déjà dans votre panier.', 'error');
                return;
            }
            
            const formData = new FormData(form);
            
            const treasureCard = form.closest('.treasure-card') || form.closest('.product-card');
            if (treasureCard) {
                treasureCard.style.opacity = '0.7';
            }
            
            fetch(addToCartUrl, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage(data.message, data.status);
                    // Update both cart indicator and summary
                    updateCartIndicator(data.cart_count, data.cart_total);
                    if (itemType === 'rank') {
                        addedRanks.add(itemId);
                        const submitButton = form.querySelector('button[type="submit"]');
                        if (submitButton) {
                            submitButton.disabled = true;
                            submitButton.style.opacity = '0.5';
                            submitButton.style.cursor = 'not-allowed';
                        }
                    }
                    if (itemType === 'store_item') {
                        const input = form.querySelector('input[name="quantity"]');
                        if (input) {
                            input.value = 1;
                        }
                    }
                } else {
                    showMessage(data.error, 'error');
                    console.error('Error adding to cart:', data.error);
                }
            })
            .catch(error => {
                console.error('AJAX error:', error);
                showMessage('Une erreur est survenue lors de l\'ajout au panier.', 'error');
            })
            .finally(() => {
                if (treasureCard) {
                    treasureCard.style.opacity = '1';
                }
            });
        });
    });
    
    // Fonction pour afficher un message temporaire
    function showMessage(message, status) {
        const messageElement = document.createElement('div');
        messageElement.className = `ajax-message ajax-message-${status}`;
        messageElement.innerHTML = `
            <div class="ajax-message-content">
                <span>${message}</span>
                <button class="ajax-message-close">×</button>
            </div>
        `;
        
        document.body.appendChild(messageElement);
        
        setTimeout(() => {
            messageElement.classList.add('show');
        }, 10);
        
        const closeButton = messageElement.querySelector('.ajax-message-close');
        closeButton.addEventListener('click', () => {
            messageElement.classList.remove('show');
            setTimeout(() => {
                messageElement.remove();
            }, 300);
        });
        
        setTimeout(() => {
            messageElement.classList.remove('show');
            setTimeout(() => {
                messageElement.remove();
            }, 300);
        }, 4000);
    }
});
</script>
{% endblock %}